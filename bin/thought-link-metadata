#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: bin/thought-link-metadata [add-githooks|remove-githooks|status-githooks|update|new]"
}

action="${1:-status-githooks}"
case "$action" in
  add-githooks)
    git config core.hooksPath .githooks
    ;;
  remove-githooks)
    git config --unset core.hooksPath || true
    ;;
  status-githooks)
    hooks_path="$(git config --get core.hooksPath || true)"
    if [[ "$hooks_path" == ".githooks" ]]; then
      echo "enabled (.githooks)"
    elif [[ -z "$hooks_path" ]]; then
      echo "disabled (default)"
    else
      echo "custom ($hooks_path)"
    fi
    ;;
  update)
    shift || true
    files=("$@")
    if [[ "${#files[@]}" -eq 0 ]]; then
      echo "no files provided!"
      exit 1
    fi
    if [[ "${HOMEBREW_INSIDE_BUNDLE:-}" != "1" ]]; then
      eval "$(brew bundle --check --install env)"
    fi
    bundle exec ruby -r ./lib/thought_link_metadata -e 'ThoughtLinkMetadata.run(ARGV)' -- "${files[@]}"
    ;;
  new)
    timestamp="$(date +"%Y%m%d%H%M")"
    file="_thoughts/${timestamp}.md"
    if [[ -e "$file" ]]; then
      timestamp="$(date +"%Y%m%d%H%M%S")"
      file="_thoughts/${timestamp}.md"
    fi

    link=""
    thought_text=""
    if [[ -t 0 ]]; then
      echo "Thought (end with Ctrl-D):"
      thought_text="$(cat < /dev/tty)"
      read -r -p "Optional link (leave blank for none): " link < /dev/tty
    else
      thought_text="$(cat)"
    fi

    if [[ -z "${thought_text//[[:space:]]/}" ]]; then
      echo "Aborted: no thought content provided."
      exit 1
    fi

    if [[ -n "$link" ]]; then
      cat > "$file" <<EOF
---
link: ${link}
---
${thought_text}
EOF
    else
      cat > "$file" <<EOF
${thought_text}
EOF
    fi

    git add "$file"

    "$0" update "$file"

    git commit --no-verify "$file" -m "Add thought ${timestamp}"

    if [[ -t 0 ]]; then
      editor="${EDITOR:-code}"
      ${editor} "$file"
    fi
    ;;
  *)
    usage
    exit 1
    ;;
esac
